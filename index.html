<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rueda de la Vida Interactiva</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for the radar chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Libraries for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Source+Serif+4:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Open Sans', sans-serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Source Serif 4', serif;
            font-weight: 700;
        }
        /* Custom styles for the range slider thumb */
        input[type=range].satisfaction-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--thumb-color, #f9442c); /* Default color */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        input[type=range].satisfaction-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--thumb-color, #f9442c);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        /* Button styles */
        .btn {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .btn-main {
            background-color: #f9442c;
            color: white;
        }
        .btn-main:hover {
            background-color: #e03c26;
        }
        .btn-ghost {
            background-color: transparent;
            border: 1px solid #d1d5db; /* gray-300 */
            color: #374151; /* gray-700 */
        }
        .btn-ghost:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        /* Styles for the hidden PDF generation container */
        #pdf-content-wrapper {
            position: absolute;
            z-index: -9999;
            left: -9999px;
            top: 0;
            width: 297mm; /* A4 landscape width */
            background: white;
            color: black;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100 pt-3">
    
    <div class="container mx-auto p-4 max-w-6xl">
        <div id="main-content" class="bg-white rounded-2xl shadow-xl overflow-hidden min-h-[70vh] flex flex-col">

            <!-- Main Interaction Container -->
            <div id="interaction-panel" class="flex-grow flex flex-col">
                
                <!-- Logo Header -->
                <div id="logo-header" class="w-full px-8 pt-8 pb-4 md:px-12 md:pt-12 md:pb-6 flex justify-center hidden">
                    <img src="https://raw.githubusercontent.com/daniel-hd-91-mx/r-v/main/Logo-Dan-Hernandez_Imagotipo-BLACK.png" alt="Logo Dan Hernandez" style="width: 250px;">
                </div>

                <!-- Welcome Flow: Initial screens -->
                <div id="welcome-flow-container" class="hidden flex-grow flex flex-col pt-4 md:pt-6 px-8 md:px-12 pb-8 md:pb-12">
                    <!-- Landing Screen -->
                    <div id="landing-screen" class="flex flex-col justify-center h-full text-center">
                        <h1 class="text-3xl md:text-4xl font-bold mb-2" style="color: #f9442c;">¿Y si tu desgaste viene de otro lugar… y no lo habías visto?</h1>
                        <div class="text-gray-600 mb-8 text-lg px-4">
                            <p>No siempre es el trabajo. A veces, el desequilibrio empieza en otra área de tu vida.</p>
                            <p class="mt-2"><strong>En 2 minutos descubrirás cuál y cómo está afectando tu energía.</strong></p>
                        </div>
                        <button id="start-experience-btn" class="w-full max-w-xs mx-auto btn btn-main font-bold py-3 px-4 rounded-lg mt-8">Descubrir mi mapa de energía</button>
                    </div>

                    <!-- User Info Screen -->
                    <div id="user-info-screen" class="hidden flex-col justify-center h-full text-center">
                        <h1 class="text-3xl md:text-4xl font-bold mb-2" style="color: #f9442c;">Un último paso...</h1>
                        <div class="w-4/5 mx-auto rounded-2xl p-8 mb-8">
                            <p class="text-gray-600 mb-6 text-lg leading-relaxed">Ingresa tu nombre para personalizar tu reporte.</p>
                            <input type="text" id="user-name-input" class="w-full max-w-xs mx-auto text-center text-2xl p-2 border-b-2 border-gray-300 focus:border-red-400 outline-none mb-8" placeholder="Tu Nombre">
                            <button id="user-info-continue-btn" class="w-full btn btn-main font-bold py-3 px-4 rounded-lg mt-8">Continuar</button>
                        </div>
                    </div>
                </div>

                <!-- Question Screen & Chart Panel Container -->
                <div id="evaluation-container" class="hidden flex-grow md:grid md:grid-cols-2">
                    <!-- Question Content -->
                    <div id="question-screen" class="p-8 md:p-12 flex flex-col">
                        <div>
                            <p id="area-counter" class="text-sm font-medium" style="color: #f9442c;">ÁREA 1 / 8</p>
                            <h2 id="area-title" class="text-2xl md:text-3xl font-bold text-gray-800 mb-4"></h2>
                            <p id="area-question" class="text-gray-600 mb-4"></p>
                        </div>
                        
                        <div class="flex-grow flex flex-col justify-center">
                            <div class="flex items-center justify-center space-x-4 mb-4">
                                <span class="text-4xl font-bold" id="slider-value">1</span>
                            </div>
                            <input id="satisfaction-slider" type="range" min="1" max="9" value="1" class="satisfaction-slider w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div id="area-slider-scale" class="flex justify-between text-xs text-gray-400 mt-2 px-1"></div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span class="font-bold">Me siento drenado/a</span>
                                <span id="max-slider-label" class="font-bold">Me siento en equilibrio</span>
                            </div>
                             <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-600 text-xs">
                                 <div id="low-level-desc"></div>
                                 <div id="high-level-desc" class="text-left md:text-right"></div>
                             </div>
                        </div>
                    </div>
                     <!-- Chart Display Panel -->
                    <div id="chart-panel" class="p-4 md:p-8 bg-white flex items-center justify-center relative">
                        <canvas id="life-wheel-chart"></canvas>
                    </div>
                </div>

                <!-- Summary Screen -->
                <div id="summary-screen" class="hidden flex-grow flex-col items-center pt-4 px-8 pb-8 md:pt-6 md:px-12 md:pb-12">
                    <!-- Title -->
                    <h1 class="text-3xl md:text-4xl font-bold mb-4 text-center" style="color: #f9442c;">Tu Fotografía Actual</h1>
                    <!-- Intro Text -->
                    <p class="text-gray-600 text-lg text-center mb-6">Aquí está el mapa de tu energía.<br>Algunas áreas te recargan. Otras, podrían estar drenándote.</p>
                    <!-- Chart Container -->
                    <div id="summary-chart-container" class="w-full max-w-lg mx-auto mb-6">
                        <!-- Canvas will be moved here by JS -->
                    </div>
                    <!-- Lowest Area Text -->
                    <p class="text-gray-600 text-lg text-center mb-4">Hoy, lo que más podría estar afectando tu equilibrio es:<br><span id="lowest-area-span" class="font-semibold text-xl text-gray-900"></span></p>
                    <!-- Areas Table -->
                    <div id="summary-table-container" class="w-full max-w-md mx-auto mb-6">
                        <!-- Table will be generated here by JS -->
                    </div>
                    <!-- Final Prompt -->
                    <p class="text-gray-600 text-lg text-center font-semibold mb-8">¿Y si comenzaras a trabajar justo ahí?</p>
                    <!-- Buttons -->
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
                        <button id="download-pdf-btn" class="btn btn-ghost font-semibold py-2 px-6 rounded-md w-full sm:w-auto">Descargar mi Fotografía</button>
                        <a href="https://tally.so/r/m6YZDB" target="_blank" rel="noopener noreferrer" class="btn btn-main font-semibold py-2 px-6 rounded-md w-full sm:w-auto">Quiero hablar con un Coach</a>
                    </div>
                    <!-- Link -->
                    <button id="summary-back-btn" class="text-sm text-gray-500 hover:text-gray-700">Reiniciar Actividad</button>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div id="navigation-buttons" class="hidden p-8 pt-0 md:col-span-2 flex justify-between items-center">
                <button id="prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg btn">Anterior</button>
                <button id="next-btn" class="btn btn-main font-bold py-2 px-6 rounded-lg">Siguiente</button>
            </div>

        </div>
    </div>

    <!-- Modal for alerts and spinners -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 max-w-sm text-center transform transition-all duration-300 scale-95">
            <p id="modal-message" class="text-gray-700 text-lg mb-6"></p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <button id="modal-confirm-btn" class="btn btn-main font-bold py-2 px-8 rounded-lg">Entendido</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden container for rendering the PDF content -->
    <div id="pdf-content-wrapper"></div>

<script type="module">
// --- CONFIGURATION AND STATE ---
const lifeAreas = [
    { labelKey: 'desarrollo_personal', question: `Tiempo que dedicas a entenderte, adquirir conocimientos y habilidades que te hacen evolucionar.`, nivelBajo: ['Vida monótona y rutinaria.', 'Sensación de estancamiento.', 'Falta de novedad o crecimiento.'], nivelAlto: ['Vida rica en experiencias.', 'Desarrollo constante de habilidades.', 'Metas y proyectos con propósito.'], score: 1 },
    { labelKey: 'hogar', question: `Tiempo que inviertes en crear y mantener un espacio físico que te brinde refugio y paz.`, nivelBajo: ['Genera estrés y caos.', 'Conflictos constantes en el espacio.', 'No se siente como un refugio.'], nivelAlto: ['Es tu santuario personal.', 'Ambiente de orden y armonía.', 'Refleja tu personalidad.'], score: 1 },
    { labelKey: 'salud', question: `Tiempo que dedicas a cuidar activamente de tu cuerpo físico y mental (alimentación, ejercicio, descanso).`, nivelBajo: ['Cansancio constante y sin energía.', 'Salud frágil y malestares frecuentes.', 'Falta de atención a tu cuerpo.'], nivelAlto: ['Lleno de energía y vitalidad.', 'Disfrutas de una rutina de ejercicio.', 'Alimentación que te nutre.'], score: 1 },
    { labelKey: 'trabajo', question: `Tu nivel de satisfacción con tus tareas diarias, tu ambiente laboral y tu trayectoria profesional.`, nivelBajo: ['Fuente de estrés y frustración.', 'No te sientes motivado ni reconocido.', 'Ambiente laboral tóxico.'], nivelAlto: ['Alineado con tu propósito y valores.', 'Disfrutas tus responsabilidades.', 'Oportunidades de crecimiento.'], score: 1 },
    { labelKey: 'amigos', question: `Tiempo que inviertes en cultivar relaciones de amistad significativas y de apoyo mutuo.`, nivelBajo: ['Sensación de soledad.', 'Relaciones superficiales o tóxicas.', 'Las interacciones te drenan.'], nivelAlto: ['Rodeado de personas de calidad.', 'Confianza y respaldo emocional.', 'Las relaciones te nutren y alegran.'], score: 1 },
    { labelKey: 'amor', question: `Tiempo que dedicas a nutrir el amor, ya sea en una relación de pareja o en la relación contigo mismo.`, nivelBajo: ['Relación con conflicto o distancia.', 'Autocrítica e inseguridad.', 'Búsqueda de validación externa.'], nivelAlto: ['Relación de alegría y apoyo.', 'Profundo amor propio y aceptación.', 'No necesitas validación externa.'], score: 1 },
    { labelKey: 'dinero', question: `Tu sensación de tranquilidad y control sobre tus finanzas personales.`, nivelBajo: ['Preocupación constante por dinero.', 'Sensación de escasez y deudas.', 'Limita tus opciones y genera estrés.'], nivelAlto: ['Control sobre tus finanzas.', 'Ingresos suficientes y tranquilidad.', 'Sensación de abundancia.'], score: 1 },
    { labelKey: 'hobbies', question: `Tiempo que te permites dedicar exclusivamente para ti, para actividades que disfrutas y te desconectan.`, nivelBajo: ['Sin tiempo para ti.', 'Vida de solo obligaciones.', 'Agotamiento y pérdida de identidad.'], nivelAlto: ['Espacios definidos para tus pasiones.', 'Te recargan de energía y relajan.', 'Aportan equilibrio a tu vida.'], score: 1 }
];

const areaLabels = {
    desarrollo_personal: ['Desarrollo', 'Personal'],
    hogar: ['Hogar'],
    salud: ['Salud'],
    trabajo: ['Trabajo'],
    amigos: ['Amigos/as'],
    amor: ['Amor', '(Pareja/Propio)'],
    dinero: ['Dinero'],
    hobbies: ['Hobbies']
};

let currentAreaIndex = 0;
let chart;
let userName = '';
const userSelectedColor = '#f9442c'; // Main theme color

// --- DOM Elements ---
const mainContent = document.getElementById('main-content');
const logoHeader = document.getElementById('logo-header');
const welcomeFlowContainer = document.getElementById('welcome-flow-container');
const landingScreen = document.getElementById('landing-screen');
const startExperienceBtn = document.getElementById('start-experience-btn');
const userInfoScreen = document.getElementById('user-info-screen');
const userNameInput = document.getElementById('user-name-input');
const userInfoContinueBtn = document.getElementById('user-info-continue-btn');
const evaluationContainer = document.getElementById('evaluation-container');
const questionScreen = document.getElementById('question-screen');
const summaryScreen = document.getElementById('summary-screen');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const navigationButtons = document.getElementById('navigation-buttons');
const areaCounter = document.getElementById('area-counter');
const areaTitle = document.getElementById('area-title');
const areaQuestion = document.getElementById('area-question');
const slider = document.getElementById('satisfaction-slider');
const sliderValue = document.getElementById('slider-value');
const areaSliderScale = document.getElementById('area-slider-scale');
const canvas = document.getElementById('life-wheel-chart');
const chartPanel = document.getElementById('chart-panel');
const alertModal = document.getElementById('alert-modal');
const modalMessage = document.getElementById('modal-message');
const modalConfirmBtn = document.getElementById('modal-confirm-btn');
const summaryBackBtn = document.getElementById('summary-back-btn');
const downloadPdfBtn = document.getElementById('download-pdf-btn');
const lowLevelDescEl = document.getElementById('low-level-desc');
const highLevelDescEl = document.getElementById('high-level-desc');

// --- UTILITY FUNCTIONS ---
function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function getAreaLabel(area) {
    return areaLabels[area.labelKey] || [area.labelKey];
}

// --- CHART LOGIC (CHART.JS) ---
function createOrUpdateChart(targetCanvas, activeIndex, showAllLabels, customData, customOptions = {}) {
    if (!targetCanvas) return;
    Chart.register(ChartDataLabels);

    const data = {
        labels: lifeAreas.map(area => getAreaLabel(area)),
        datasets: customData || [{
            data: lifeAreas.map(area => area.score),
            fill: true,
            backgroundColor: hexToRgba(userSelectedColor, 0.4),
            borderColor: userSelectedColor,
            pointBackgroundColor: userSelectedColor,
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: userSelectedColor,
        }]
    };

    const options = {
        maintainAspectRatio: false,
        scales: {
            r: {
                angleLines: { display: true, color: 'rgba(0, 0, 0, 0.1)' },
                suggestedMin: 0,
                suggestedMax: 9,
                pointLabels: {
                    font: (context) => ({
                        family: "'Open Sans', sans-serif",
                        size: window.innerWidth < 768 ? 10 : 12,
                        weight: context.index === activeIndex || showAllLabels ? 'bold' : '500'
                    }),
                    color: (context) => (context.index === activeIndex || showAllLabels) ? '#000000' : '#6b7280'
                },
                grid: { color: 'rgba(0, 0, 0, 0.1)' },
                ticks: { display: false, stepSize: 1 }
            }
        },
        plugins: {
            legend: { display: false },
            tooltip: { enabled: true },
            datalabels: {
                color: '#ffffff',
                backgroundColor: hexToRgba(userSelectedColor, 0.8),
                borderRadius: 4,
                font: { weight: 'bold' },
                padding: 4,
                display: (context) => showAllLabels,
            }
        },
        ...customOptions
    };
    
    const config = { type: 'radar', data, options };

    if (targetCanvas.chart) {
        targetCanvas.chart.destroy();
    }
    targetCanvas.chart = new Chart(targetCanvas, config);
}

// --- MODAL & UI FEEDBACK ---
function showSpinner(message) {
    modalMessage.textContent = message;
    modalConfirmBtn.style.display = 'none'; // Hide button for spinner
    alertModal.classList.remove('hidden');
    setTimeout(() => alertModal.classList.remove('opacity-0'), 10);
}

function hideSpinner() {
    alertModal.classList.add('opacity-0');
    setTimeout(() => {
        alertModal.classList.add('hidden');
        modalConfirmBtn.style.display = 'inline-block'; // Restore button
    }, 300);
}

// --- PDF EXPORT LOGIC ---
async function exportPDF() {
    if (!window.jspdf || !window.html2canvas) {
        showSpinner("Error al cargar librerías para PDF.");
        setTimeout(hideSpinner, 2000);
        return;
    }

    showSpinner('Generando tu Fotografía en PDF...');
    await new Promise(resolve => setTimeout(resolve, 100)); // Wait for spinner to show

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape
    const contentWrapper = document.getElementById('pdf-content-wrapper');

    const minScore = Math.min(...lifeAreas.map(area => area.score));
    const lowestAreasKeys = lifeAreas
        .filter(area => area.score === minScore)
        .map(area => area.labelKey);

    const tableRows = lifeAreas.map(area => {
        const isLowest = lowestAreasKeys.includes(area.labelKey);
        const rowStyle = isLowest ? 'background-color: #fff5f5; font-weight: bold; color: #d32f2f;' : '';
        return `
            <tr style="border-bottom: 1px solid #eee; ${rowStyle}">
                <td style="padding: 5px 8px;">${getAreaLabel(area).join(' ')}</td>
                <td style="padding: 5px 8px; text-align: right;">${area.score}</td>
            </tr>`;
    }).join('');
    
    const lowestAreasSummary = `<p style="font-size: 14px; margin-top: 15px; color: #d32f2f;">Área más baja detectada: <strong>${lowestAreasKeys.map(key => getAreaLabel({labelKey: key}).join(' ')).join(' y ')}</strong></p>`;

    const pdfHTML = `
        <div id="pdf-render-area" style="width: 297mm; height: 210mm; padding: 15mm; background: white; font-family: 'Open Sans', sans-serif; display: flex; align-items: center; justify-content: space-between; box-sizing: border-box;">
            <div style="width: 58%; height: 100%; display: flex; align-items: center; justify-content: center;">
                 <canvas id="pdf-chart" style="max-width: 100%; max-height: 100%;"></canvas>
            </div>
            <div style="width: 38%; padding-left: 20px; box-sizing: border-box;">
                <img src="https://raw.githubusercontent.com/daniel-hd-91-mx/r-v/main/Logo-Dan-Hernandez_Imagotipo-BLACK.png" alt="Logo Dan Hernandez" style="width: 250px; margin: 0 auto 20px auto; display: block;">
                <h1 style="font-family: 'Source Serif 4', serif; font-size: 28px; font-weight: 700; color: #333; margin: 0; text-align: center;">Tu Fotografía Actual</h1>
                <p style="font-size: 14px; margin-top: 10px; color: #555;"><strong>Usuario:</strong> ${userName || 'N/A'}</p>
                <p style="font-size: 14px; margin-top: 5px; color: #555;"><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
                ${lowestAreasSummary}
                <table style="width: 100%; margin-top: 20px; font-size: 13px; border-collapse: collapse; border: 1px solid #ddd;">
                    <thead style="background-color: #f7f7f7;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <th style="text-align: left; padding: 8px;">Dimensión</th>
                            <th style="text-align: right; padding: 8px;">Valor</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        </div>`;

    contentWrapper.innerHTML = pdfHTML;
    
    createOrUpdateChart(document.getElementById('pdf-chart'), null, true);

    await new Promise(resolve => setTimeout(resolve, 500)); 

    try {
        const pdfRenderArea = document.getElementById('pdf-render-area');
        const canvas = await html2canvas(pdfRenderArea, { scale: 2, useCORS: true, backgroundColor: '#FFFFFF' });
        const imgData = canvas.toDataURL('image/png');
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`Mi-Fotografia-Actual-${userName || 'Resultados'}.pdf`);

    } catch (error) {
        console.error("Error generating PDF:", error);
        showSpinner("Ocurrió un error al crear el PDF.");
        setTimeout(hideSpinner, 2000);
    } finally {
        contentWrapper.innerHTML = '';
        hideSpinner();
    }
}

// --- SCREEN NAVIGATION & LOGIC ---
const allScreens = [welcomeFlowContainer, evaluationContainer, summaryScreen];

function showScreen(screenId) {
    // Hide all screens first
    allScreens.forEach(screen => {
        screen.classList.add('hidden');
        screen.classList.remove('flex', 'flex-col', 'md:grid');
    });

    // Hide logo and nav buttons by default, show as needed
    logoHeader.classList.add('hidden');
    navigationButtons.classList.add('hidden');

    // Show the target screen and its specific dependencies
    if (screenId === 'welcome') {
        logoHeader.classList.remove('hidden');
        welcomeFlowContainer.classList.remove('hidden');
        welcomeFlowContainer.classList.add('flex', 'flex-col');
    } else if (screenId === 'evaluation') {
        evaluationContainer.classList.remove('hidden');
        evaluationContainer.classList.add('flex-grow', 'md:grid');
        navigationButtons.classList.remove('hidden');
        navigationButtons.classList.add('flex');
    } else if (screenId === 'summary') {
        logoHeader.classList.remove('hidden');
        summaryScreen.classList.remove('hidden');
        summaryScreen.classList.add('flex', 'flex-col');
    }
}


function showQuestion(index) {
    const area = lifeAreas[index];
    const label = getAreaLabel(area);
    areaCounter.textContent = `ÁREA ${index + 1} / ${lifeAreas.length}`;
    areaTitle.textContent = Array.isArray(label) ? label.join(' ') : label;
    areaQuestion.innerHTML = area.question;

    lowLevelDescEl.innerHTML = `<ul class='list-disc list-inside text-xs mt-1 space-y-1'>${area.nivelBajo.map(item => `<li>${item}</li>`).join('')}</ul>`;
    highLevelDescEl.innerHTML = `<ul class='list-disc list-inside text-xs mt-1 space-y-1'>${area.nivelAlto.map(item => `<li>${item}</li>`).join('')}</ul>`;

    let currentScore = area.score || 1;
    slider.value = currentScore;
    sliderValue.textContent = currentScore;
    sliderValue.style.color = userSelectedColor;
    
    updateSliderFill(slider);

    prevBtn.style.visibility = index > 0 ? 'visible' : 'hidden';
    nextBtn.textContent = index === lifeAreas.length - 1 ? 'Finalizar' : 'Siguiente';
    
    areaSliderScale.innerHTML = '';
    for(let i=1; i <= 9; i++){
        const span = document.createElement('span');
        span.textContent = i;
        areaSliderScale.appendChild(span);
    }
    
    createOrUpdateChart(canvas, index, false);
}

function startEvaluation() {
    showScreen('evaluation');

    if (canvas.parentNode !== chartPanel) {
        chartPanel.appendChild(canvas);
    }
    
    lifeAreas.forEach(area => { area.score = area.score > 0 ? area.score : 1; });
    currentAreaIndex = 0;
    showQuestion(0);
}

function nextArea() {
    lifeAreas[currentAreaIndex].score = parseInt(slider.value);

    if (currentAreaIndex < lifeAreas.length - 1) {
        currentAreaIndex++;
        showQuestion(currentAreaIndex);
    } else {
        showSummary();
    }
}

function prevArea() {
    if (currentAreaIndex > 0) {
        currentAreaIndex--;
        showQuestion(currentAreaIndex);
    }
}

function showSummary() {
    showScreen('summary');

    const summaryChartContainer = document.getElementById('summary-chart-container');
    summaryChartContainer.innerHTML = ''; 
    summaryChartContainer.appendChild(canvas);
    canvas.style.maxHeight = '400px';

    const summaryTableContainer = document.getElementById('summary-table-container');
    const minScore = Math.min(...lifeAreas.map(area => area.score));
    
    const lowestScoringAreas = lifeAreas.filter(area => area.score === minScore);

    const tableRows = lowestScoringAreas.map(area => {
        const rowStyle = 'background-color: #fee2e2; font-weight: bold;';
        return `<tr style="${rowStyle}">
                    <td class="py-2 px-4 border-b">${getAreaLabel(area).join(' ')}</td>
                    <td class="py-2 px-4 border-b text-right">${area.score}</td>
                </tr>`;
    }).join('');

    summaryTableContainer.innerHTML = `
        <table class="w-full text-left border-collapse">
            <thead>
                <tr>
                    <th class="py-2 px-4 bg-gray-100 border-b font-semibold">Área de Enfoque</th>
                    <th class="py-2 px-4 bg-gray-100 border-b font-semibold text-right">Puntuación</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
        </table>`;

    const lowestAreas = lifeAreas
      .filter(area => area.score === minScore)
      .map(area => getAreaLabel(area).join(' '));
    const lowestAreaSpan = document.getElementById('lowest-area-span');
    if (lowestAreaSpan) {
        lowestAreaSpan.innerHTML = `<strong>${lowestAreas.join(' y ')}</strong>`;
    }

    createOrUpdateChart(canvas, null, true);
}

function resetApp() {
    lifeAreas.forEach(area => { area.score = 1; });
    userName = '';
    currentAreaIndex = 0;
    userNameInput.value = '';

    if (canvas.parentNode !== chartPanel) {
        chartPanel.appendChild(canvas);
    }
    
    showScreen('welcome');

    landingScreen.classList.remove('hidden');
    userInfoScreen.classList.add('hidden');
}

function updateSliderFill(sliderElement) {
    const percentage = (sliderElement.value - sliderElement.min) / (sliderElement.max - sliderElement.min) * 100;
    sliderElement.style.background = `linear-gradient(to right, ${userSelectedColor} ${percentage}%, #e5e7eb ${percentage}%)`;
    sliderElement.style.setProperty('--thumb-color', userSelectedColor);
}

// --- EVENT LISTENERS ---
startExperienceBtn.addEventListener('click', () => {
    landingScreen.classList.add('hidden');
    userInfoScreen.classList.remove('hidden');
    userInfoScreen.classList.add('flex');
});

userInfoContinueBtn.addEventListener('click', () => {
    const name = userNameInput.value.trim();
    if (name) {
        userName = name;
        startEvaluation();
    } else {
        showSpinner("Por favor, introduce tu nombre.");
        setTimeout(hideSpinner, 2000);
    }
});

nextBtn.addEventListener('click', nextArea);
prevBtn.addEventListener('click', prevArea);
summaryBackBtn.addEventListener('click', resetApp);
downloadPdfBtn.addEventListener('click', exportPDF);
    
slider.addEventListener('input', (e) => {
    let newScore = parseInt(e.target.value);
    sliderValue.textContent = newScore;
    lifeAreas[currentAreaIndex].score = newScore;
    updateSliderFill(e.target);
    createOrUpdateChart(canvas, currentAreaIndex, false);
});

modalConfirmBtn.addEventListener('click', hideSpinner);

// --- INITIALIZATION ---
function initializeApp() {
    slider.style.setProperty('--thumb-color', userSelectedColor);
    showScreen('welcome');
    landingScreen.classList.remove('hidden');
    console.log("Interactive Wheel of Life (with descriptions) initialized.");
}

initializeApp();
</script>

</body>
</html>

</body>
</html>
